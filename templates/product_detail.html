{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12 mb-3">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('catalog.view_catalog') }}">–ö–∞—Ç–∞–ª–æ–≥</a></li>
                    <li class="breadcrumb-item active">{{ product.name }}</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card">
                <div class="product-detail-image" style="text-align: center; background: #f8f9fa; padding: 20px;">
                    <img src="{{ url_for('static', filename='images/products/' + product.image) }}" 
                         alt="{{ product.name }}"
                         class="img-fluid"
                         style="max-height: 500px; width: auto;"
                         onerror="this.src='{{ url_for('static', filename='images/products/default_shoe.jpg') }}'">
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card">
                <div class="card-body">
                    <h1 class="card-title">{{ product.name }}</h1>
                    <p class="text-muted">{{ product.description }}</p>
                    
                    <div class="product-price mb-3">
                        <h2 class="text-success">{{ "%.2f"|format(product.price) }} –ª–≤.</h2>
                    </div>

                    <div class="product-specs mb-4">
                        <h4> –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏</h4>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <strong>–¶–≤—è—Ç:</strong>
                                <span class="badge bg-secondary">{{ product.color }}</span>
                            </li>
                            <li class="mb-2">
                                <strong>–ù–∞–ª–∏—á–Ω–∏ —Ä–∞–∑–º–µ—Ä–∏:</strong>
                                <div class="mt-1">
                                    {% if product.sizes_stock is mapping %}
                                        {% for size, stock in product.sizes_stock.items() if stock > 0 %}
                                        <span class="badge bg-primary me-1 mb-1" style="font-size: 1em;">
                                            {{ size }} ({{ stock }} –±—Ä.)
                                        </span>
                                        {% endfor %}
                                    {% else %}
                                        <span class="badge bg-warning">–ù—è–º–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ —Ä–∞–∑–º–µ—Ä–∏</span>
                                    {% endif %}
                                </div>
                            </li>

                            <li class="mb-2">
                                <strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong>
                                <span class="badge bg-dark">
                                    {% if 'nike' in product.name.lower() or 'adidas' in product.name.lower() or 'puma' in product.name.lower() %}
                                        –°–ø–æ—Ä—Ç–Ω–∏ –æ–±—É–≤–∫–∏
                                    {% elif 'vans' in product.name.lower() or 'converse' in product.name.lower() %}
                                        –ö–µ—Ü–æ–≤–µ
                                    {% elif 'boot' in product.name.lower() %}
                                        –ß–∏–∑–º–∏
                                    {% else %}
                                        –û–±—É–≤–∫–∏
                                    {% endif %}
                                </span>
                            </li>
                        </ul>
                    </div>

                    <div class="add-to-cart-section">
                        <h4>üõí –î–æ–±–∞–≤–∏ –≤ –∫–æ—à–Ω–∏—Ü–∞</h4>
                        {% if session.user_id %}
                        <form method="POST" action="{{ url_for('cart.add_product_to_cart', product_id=product.id) }}">
                            <div class="row g-3 align-items-center">
                                <div class="col-md-6">
                                    <label for="size" class="form-label"><strong>–ò–∑–±–µ—Ä–∏ —Ä–∞–∑–º–µ—Ä:</strong></label>
                                    <select name="size" id="size" class="form-select" required>
                                        <option value="">-- –ò–∑–±–µ—Ä–µ—Ç–µ —Ä–∞–∑–º–µ—Ä --</option>
                                        {% if product.sizes_stock is mapping %}
                                            {% for size, stock in product.sizes_stock.items() if stock > 0 %}
                                            <option value="{{ size }}">–†–∞–∑–º–µ—Ä {{ size }} (–æ—Å—Ç–∞–Ω–∞–ª–∏ {{ stock }} –±—Ä.)</option>
                                            {% endfor %}
                                        {% endif %}
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="quantity" class="form-label"><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</strong></label>
                                    <input type="number" name="quantity" id="quantity" value="1" min="1" max="10" 
                                           class="form-control">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" style="visibility: hidden;">–ë—É—Ç–æ–Ω</label>
                                    <button type="submit" class="btn btn-success w-100">
                                        üõí –î–æ–±–∞–≤–∏
                                    </button>
                                </div>
                            </div>
                        </form>
                        {% else %}
                        <div class="alert alert-info">
                            <p>–ó–∞ –¥–∞ –∫—É–ø–∏—Ç–µ —Ç–æ–∑–∏ –ø—Ä–æ–¥—É–∫—Ç, –º–æ–ª—è <a href="{{ url_for('auth.login') }}">–≤–ª–µ–∑—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏</a> 
                            –∏–ª–∏ <a href="{{ url_for('auth.register') }}">—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π—Ç–µ</a>.</p>
                        </div>
                        {% endif %}
                    </div>

                    <div class="product-info mt-4">
                        <h5>‚ÑπÔ∏è –î–æ–ø—ä–ª–Ω–∏—Ç–µ–ª–Ω–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                        <div class="accordion" id="productAccordion">
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#deliveryInfo">
                                        üöö –î–æ—Å—Ç–∞–≤–∫–∞ –∏ –≤—Ä—ä—â–∞–Ω–µ
                                    </button>
                                </h2>
                                <div id="deliveryInfo" class="accordion-collapse collapse show" 
                                     data-bs-parent="#productAccordion">
                                    <div class="accordion-body">
                                        <p>‚úÖ –ë–µ–∑–ø–ª–∞—Ç–Ω–∞ –¥–æ—Å—Ç–∞–≤–∫–∞ –∑–∞ –ø–æ—Ä—ä—á–∫–∏ –Ω–∞–¥ 100 –ª–≤.</p>
                                        <p>‚úÖ –í—Ä—ä—â–∞–Ω–µ –≤ —Å—Ä–æ–∫ –æ—Ç 14 –¥–Ω–∏</p>
                                        <p>‚úÖ –î–æ—Å—Ç–∞–≤–∫–∞ –≤ —Ä–∞–º–∫–∏—Ç–µ –Ω–∞ 2-3 —Ä–∞–±–æ—Ç–Ω–∏ –¥–Ω–∏</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" 
                                            data-bs-target="#materialInfo">
                                        –ú–∞—Ç–µ—Ä–∏–∞–ª–∏ –∏ –≥—Ä–∏–∂–∞
                                    </button>
                                </h2>
                                <div id="materialInfo" class="accordion-collapse collapse" 
                                     data-bs-parent="#productAccordion">
                                    <div class="accordion-body">
                                        <p>‚Ä¢ –í–∏—Å–æ–∫–æ–∫–∞—á–µ—Å—Ç–≤–µ–Ω–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–∏</p>
                                        <p>‚Ä¢ –ü–æ–¥—Ö–æ–¥—è—â–∏ –∑–∞ –µ–∂–µ–¥–Ω–µ–≤–Ω–∞ —É–ø–æ—Ç—Ä–µ–±–∞</p>
                                        <p>‚Ä¢ –ü—Ä–µ–ø–æ—Ä—ä—á–∏—Ç–µ–ª–Ω–∞ –≥—Ä–∏–∂–∞: –ü–æ—á–∏—Å—Ç–≤–∞–Ω–µ —Å –º–µ–∫–∞ –∫—ä—Ä–ø–∞</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
     <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4>‚≠ê –†–µ–π—Ç–∏–Ω–≥ –∏ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏</h4>
                </div>
                <div class="card-body">
                    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ —Ä–µ–π—Ç–∏–Ω–≥–∞ -->
                    <div class="row mb-4">
                        <div class="col-md-4 text-center">
                            <div class="display-4 text-warning">{{ rating_stats.average }}</div>
                            <div class="stars mb-2">
                                {% for i in range(1, 6) %}
                                    {% if i <= rating_stats.average %}
                                        <span class="text-warning">‚òÖ</span>
                                    {% else %}
                                        <span class="text-muted">‚òÖ</span>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            <small class="text-muted">–ë–∞–∑–∏—Ä–∞–Ω–æ –Ω–∞ {{ rating_stats.count }} –æ—Ü–µ–Ω–∫–∏</small>
                        </div>
                        <div class="col-md-8">
                            <!-- –†–∞–∑–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞ —Ä–µ–π—Ç–∏–Ω–≥–∏—Ç–µ -->
                            {% for stars in [5,4,3,2,1] %}
                            <div class="row align-items-center mb-1">
                                <div class="col-1">
                                    <small>{{ stars }}‚òÖ</small>
                                </div>
                                <div class="col-8">
                                    <div class="progress" style="height: 8px;">
                                        <div class="progress-bar bg-warning"
                                             style="width: {{ (rating_stats.distribution[stars] / rating_stats.count * 100) if rating_stats.count > 0 else 0 }}%">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <small class="text-muted">{{ rating_stats.distribution[stars] }}</small>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    {% if session.user_id %}
                    <div class="rating-form mb-4">
                        <h5>–î–æ–±–∞–≤–∏ —Ç–≤–æ—è—Ç–∞ –æ—Ü–µ–Ω–∫–∞</h5>
                        <form method="POST" action="{{ url_for('catalog.rate_product', product_id=product.id) }}">
                            <div class="mb-3">
                                <label class="form-label">–û—Ü–µ–Ω–∫–∞:</label>
                                <div class="star-rating">
                                    {% for i in range(1, 6) %}
                                    <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}"
                                           {% if user_rating and user_rating.rating == i %}checked{% endif %}>
                                    <label for="star{{ i }}" class="star-label">‚òÖ</label>
                                    {% endfor %}
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="comment" class="form-label">–ö–æ–º–µ–Ω—Ç–∞—Ä (–ø–æ –∏–∑–±–æ—Ä):</label>
                                <textarea class="form-control" id="comment" name="comment" rows="3"
                                          placeholder="–°–ø–æ–¥–µ–ª–∏ —Ç–≤–æ–µ—Ç–æ –º–Ω–µ–Ω–∏–µ –∑–∞ —Ç–æ–∑–∏ –ø—Ä–æ–¥—É–∫—Ç...">{% if user_rating %}{{ user_rating.comment }}{% endif %}</textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                {% if user_rating %}–û–±–Ω–æ–≤–∏ –æ—Ü–µ–Ω–∫–∞{% else %}–î–æ–±–∞–≤–∏ –æ—Ü–µ–Ω–∫–∞{% endif %}
                            </button>
                        </form>
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <a href="{{ url_for('auth.login') }}" class="alert-link">–í–ª–µ–∑—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª–∞ —Å–∏</a> –∑–∞ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ –≤–∞—à–∞—Ç–∞ –æ—Ü–µ–Ω–∫–∞ –∏ –∫–æ–º–µ–Ω—Ç–∞—Ä.
                    </div>
                    {% endif %}

                    <div class="comments-section">
                        <h5> –ö–æ–º–µ–Ω—Ç–∞—Ä–∏ –Ω–∞ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª–∏ ({{ ratings|length }})</h5>
                        {% if ratings %}
                            {% for rating in ratings %}
                            <div class="card mb-3 {% if rating.user_id == session.user_id %}border-primary{% endif %}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <strong>
                                                {% if rating.user_id == session.user_id %}
                                                    –í–∏–µ
                                                {% else %}
                                                    –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª {{ rating.user_id }}
                                                {% endif %}
                                            </strong>
                                            <div class="stars small">
                                                {% for i in range(1, 6) %}
                                                    {% if i <= rating.rating %}
                                                        <span class="text-warning">‚òÖ</span>
                                                    {% else %}
                                                        <span class="text-muted">‚òÖ</span>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                        <small class="text-muted">{{ rating.created_at or "–ü—Ä–µ–¥–∏ –º–∞–ª–∫–æ" }}</small>
                                    </div>
                                    {% if rating.comment %}
                                    <p class="mt-2 mb-0">{{ rating.comment }}</p>
                                    {% else %}
                                    <p class="mt-2 mb-0 text-muted">–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—è—Ç –Ω–µ –µ –æ—Å—Ç–∞–≤–∏–ª –∫–æ–º–µ–Ω—Ç–∞—Ä.</p>
                                    {% endif %}
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center text-muted py-4">
                                <p>–í—Å–µ –æ—â–µ –Ω—è–º–∞ –∫–æ–º–µ–Ω—Ç–∞—Ä–∏ –∑–∞ —Ç–æ–∑–∏ –ø—Ä–æ–¥—É–∫—Ç.</p>
                                <p>–ë—ä–¥–µ—Ç–µ –ø—ä—Ä–≤–∏—è—Ç, –∫–æ–π—Ç–æ —â–µ –æ—Ü–µ–Ω–∏!</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="row mt-5">
        <div class="col-12">
            <h3>üëü –ü–æ–¥–æ–±–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏</h3>
            <div class="alert alert-info">
                <p class="mb-0">–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç—Ç–∞ –∑–∞ –ø–æ–¥–æ–±–Ω–∏ –ø—Ä–æ–¥—É–∫—Ç–∏ —â–µ –±—ä–¥–µ –¥–æ–±–∞–≤–µ–Ω–∞ —Å–∫–æ—Ä–æ!</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}